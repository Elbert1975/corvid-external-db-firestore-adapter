<h1 align="center">
  Corvid Connector for Google Cloud Firestore
</h1>

This project allows to plug in [Google Cloud Firestore](https://cloud.google.com/firestore/) into [Corvid by Wix](https://www.wix.com/corvid) site and use it as a Corvid collection database. It is implemented as NodeJS server that can be deployed either to [Google Cloud Run](https://cloud.google.com/run/) or [AppEngine](https://cloud.google.com/appengine/). After Connector is deployed it can be used as [Corvid External Database](https://support.wix.com/en/article/corvid-adding-and-deleting-an-external-database-collection).

# Getting started

This project assumes you have Google Cloud Project with billing enabled. If you don't have one please follow this [free trial guide](https://cloud.google.com/free/).

## Enable Firestore in Native Mode
Go to https://console.cloud.google.com/firestore/welcome and select **Native Mode**

## Deploying to Cloud Run using Cloud Console

Follow instructions on the Google Cloud Run [quickstart guide](https://cloud.google.com/run/docs/quickstarts/prebuilt-deploy).
In the form of creating service,

1. Use **gcr.io/corvid-api/firestore-connector-node** as a container image.
2. Select Cloud Run **(fully managed)** as your development platform.
3. Select **us-east1** region.
4. Select **Allow unauthenticated invocations** to be able to access the connector from Corvid
5. Click *Create* to deploy the image to Cloud Run and wait for the deployment to finish.

Click the displayed URL link to test the deployed connector.
In the browser you should see
> {"message":"Missing request context"}

**This means that connector is running!** Copy the service URL, **this is the URL for connecting Firestore to Corvid site**

## Deployment to Google Cloud Run using gcloud CLI

* Install the [Google Cloud SDK](https://cloud.google.com/sdk/docs/quickstarts) for your operating system;
* Acquire local credentials;

    ```bash
    gcloud auth application-default login
    ```

* Set project you have created as default by running

    ```bash
    gcloud config set project PROJECTID
    ```

* Deploy the Corvid connector container

    ```bash
    gcloud run deploy --image gcr.io/corvid-api/firestore-connector-node --platform managed --region us-east1
    ```

  * Answer **y** when prompted "Allow unauthenticated invocations to [firestore-connector-node] (y/N)?"
  * After deployment is successful, you should see in the command output something like:

    > Service [firestore-connector-node] revision [firestore-connector-node-00001-nep] has been deployed and is serving 100 percent of traffic at <https://firestore-connector-node-[autogenerated].run.app>
  * Copy the service URL, **this is the URL for connecting Firestore to Corvid site**
  
## Deployment to Google App Engine using gcloud CLI

* Run deployment command in your connector project folder.

  ```bash
  gcloud app deploy
	```

* After deployment, access your service at `https://<project name>.appspot.com/`

# Development

* Check out the source code

  ```bash
   git clone https://github.com/wix-private/firestore-connector-node.git
   cd firestore-connector-node
  ```

* Create a [GCP Service account](https://cloud.google.com/iam/docs/service-accounts)

  ```bash
  gcloud iam service-accounts create corvid --description Corvid Dev account --display-name corvid-dev
  ```

  and copy its full name from output of

  ```bash
  gcloud iam service-accounts list
  ```

* Generate the Service Account key and save it in gcp-sa-key.json

  ```bash
  gcloud iam service-accounts keys create gcp-sa-key.json --iam-account [SERVICE ACCOUNT FULL NAME]
  ```

* Set environment variable for GCP client libraries

  ```bash
  export GOOGLE_APPLICATION_CREDENTIALS=$PWD/gcp-sa-key.json
  ```

* The Connector is NodeJS express application, start it with

  ```bash
  npm install

  npm start
  ```
